<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šå¸‚å…¬å¸å…¬å‘Šä¸‹è½½å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #f8f9fc;
            min-height: 100vh;
            display: flex;
        }
        
        /* Sidebar */
        .sidebar {
            width: 220px;
            background: linear-gradient(180deg, #5b8def 0%, #4a7bd4 100%);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
        }
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .sidebar-header h1 {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            line-height: 1.4;
        }
        .sidebar-header span {
            font-size: 11px;
            color: rgba(255,255,255,0.4);
        }
        .nav-section {
            padding: 16px 12px;
        }
        .nav-label {
            font-size: 11px;
            color: rgba(255,255,255,0.35);
            padding: 8px 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-size: 13px;
            color: rgba(255,255,255,0.65);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }
        .nav-item:hover {
            background: rgba(255,255,255,0.06);
            color: #fff;
        }
        .nav-item.active {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }
        .nav-icon { font-size: 16px; }
        
        /* Main */
        .main {
            flex: 1;
            margin-left: 220px;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: #fff;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #eef0f3;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        .header-subtitle {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }
        
        /* Content */
        .content {
            padding: 28px 32px;
        }
        
        /* Panel */
        .panel { display: none; }
        .panel.active { display: block; }
        
        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }
        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px 24px;
            border: 1px solid #eef0f3;
            cursor: pointer;
            transition: all 0.2s;
        }
        .stat-card:hover {
            border-color: #a78bfa;
            box-shadow: 0 4px 12px rgba(167,139,250,0.15);
        }
        .stat-card.active {
            border-color: #7c3aed;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
        }
        .stat-card.active .stat-value { color: #7c3aed; }
        
        /* Form Card */
        .form-card {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #eef0f3;
            overflow: hidden;
        }
        .form-card-header {
            padding: 18px 24px;
            background: #fafbfc;
            border-bottom: 1px solid #eef0f3;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .form-card-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }
        .form-card-body {
            padding: 24px;
        }
        
        /* Form */
        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            align-items: flex-start;
        }
        .form-row:last-child { margin-bottom: 0; }
        .form-group {
            flex: 1;
        }
        .form-group.small { flex: 0 0 200px; }
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        .form-label .required { color: #ef4444; }
        .form-label .hint { color: #9ca3af; font-weight: 400; font-size: 12px; }
        
        input[type="text"], input[type="date"], select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            color: #374151;
            background: #fff;
            transition: all 0.15s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124,58,237,0.1);
        }
        input::placeholder { color: #d1d5db; }
        
        .input-with-btn {
            display: flex;
            gap: 8px;
        }
        .input-with-btn input { flex: 1; }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .btn-ghost {
            background: #f3f4f6;
            color: #4b5563;
        }
        .btn-ghost:hover { background: #e5e7eb; }
        .btn-primary {
            background: #7c3aed;
            color: #fff;
        }
        .btn-primary:hover { background: #6d28d9; }
        .btn-success {
            background: #10b981;
            color: #fff;
        }
        .btn-success:hover { background: #059669; }
        
        /* Checkbox */
        .checkbox-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .checkbox-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 13px;
            color: #4b5563;
        }
        .checkbox-tag:hover { border-color: #7c3aed; }
        .checkbox-tag input { accent-color: #7c3aed; }
        
        /* File Upload */
        .file-box {
            margin-top: 12px;
            padding: 16px;
            background: #f9fafb;
            border: 1px dashed #e5e7eb;
            border-radius: 8px;
        }
        .file-box-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 10px;
        }
        
        /* Status */
        .status-msg {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: none;
        }
        .status-msg.show { display: block; }
        .status-msg.success { background: #ecfdf5; color: #065f46; }
        .status-msg.error { background: #fef2f2; color: #991b1b; }
        
        /* Results */
        .results-card {
            margin-top: 24px;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #eef0f3;
            display: none;
        }
        .results-card.show { display: block; }
        .results-header {
            padding: 16px 24px;
            background: #fafbfc;
            border-bottom: 1px solid #eef0f3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .results-header h4 { font-size: 14px; font-weight: 600; color: #374151; }
        .results-count { font-size: 12px; color: #6b7280; margin-top: 2px; }
        .results-actions { display: flex; gap: 8px; }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        .results-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            background: #f9fafb;
            border-bottom: 1px solid #eef0f3;
        }
        .results-table td {
            padding: 14px 16px;
            font-size: 13px;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
        }
        .results-table tr:hover { background: #fafbfc; }
        .results-table .code-badge {
            display: inline-block;
            padding: 3px 8px;
            background: #7c3aed;
            color: #fff;
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
        }
        .results-table-wrap { max-height: 400px; overflow-y: auto; }
        
        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.92);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-overlay.show { display: flex; }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top-color: #7c3aed;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 14px; color: #4b5563; }
        .loading-box { text-align: center; }
        
        /* Action Bar */
        .action-bar {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>ä¸Šå¸‚å…¬å¸å…¬å‘Š<br>ä¸‹è½½å·¥å…·</h1>
        </div>
        <nav class="nav-section">
            <div class="nav-label">åŠŸèƒ½èœå•</div>
            <button class="nav-item" data-tab="single">
                <span class="nav-icon">ğŸ“„</span>å•è‚¡æŠ¥å‘Šä¸‹è½½
            </button>
            <button class="nav-item" data-tab="periodic">
                <span class="nav-icon">ğŸ“Š</span>å®šæœŸæŠ¥å‘Šä¸‹è½½
            </button>
            <button class="nav-item active" data-tab="multi">
                <span class="nav-icon">ğŸ“</span>å¤šè‚¡æŠ¥å‘Šä¸‹è½½
            </button>
        </nav>
    </aside>
    
    <!-- Main -->
    <main class="main">
        <header class="header">
            <div>
                <div class="header-title" id="header-title">å¤šè‚¡æŠ¥å‘Šä¸‹è½½</div>
                <div class="header-subtitle">åŒæ—¶ä¸‹è½½å¤šåªè‚¡ç¥¨çš„å…¬å‘Šæ–‡ä»¶</div>
            </div>
        </header>
        
        <div class="content">
            <!-- å•è‚¡ -->
            <div id="panel-single" class="panel">
                <div class="form-card">
                    <div class="form-card-header">
                        <h3>ç­›é€‰æ¡ä»¶</h3>
                    </div>
                    <div class="form-card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label"><span class="required">*</span> è‚¡ç¥¨ä»£ç </label>
                                <div class="input-with-btn">
                                    <input type="text" id="single-stock" placeholder="è¾“å…¥6ä½è‚¡ç¥¨ä»£ç ï¼Œå¦‚ 000001">
                                    <button class="btn btn-ghost" onclick="checkStock('single')">ç¡®å®š</button>
                                </div>
                                <div id="single-stock-status" class="status-msg"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æœç´¢å…³é”®è¯ <span class="hint">å¤šä¸ªç”¨ç©ºæ ¼éš”å¼€</span></label>
                                <div class="input-with-btn">
                                    <input type="text" id="single-keywords" placeholder="å¦‚: å¹´åº¦æŠ¥å‘Š åˆ©æ¶¦åˆ†é…">
                                    <button class="btn btn-ghost" onclick="confirmKeyword('single')">ç¡®å®š</button>
                                </div>
                                <div id="single-keyword-status" class="status-msg"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">æŠ¥å‘Šç±»å‹</label>
                                <div class="checkbox-row">
                                    <label class="checkbox-tag"><input type="checkbox" value="å¹´æŠ¥" class="single-category">å¹´æŠ¥</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="åŠå¹´æŠ¥" class="single-category">åŠå¹´æŠ¥</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="ä¸€å­£åº¦æŠ¥" class="single-category">ä¸€å­£åº¦æŠ¥</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="ä¸‰å­£åº¦æŠ¥" class="single-category">ä¸‰å­£åº¦æŠ¥</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="å…¶ä»–" class="single-category">å…¶ä»–</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group small">
                                <label class="form-label">èµ·å§‹æ—¥æœŸ</label>
                                <input type="date" id="single-start-date" value="2024-01-01">
                            </div>
                            <div class="form-group small">
                                <label class="form-label">ç»ˆæ­¢æ—¥æœŸ</label>
                                <input type="date" id="single-end-date" value="2024-12-31">
                            </div>
                            <div class="form-group" style="flex:0;align-self:flex-end;">
                                <button class="btn btn-primary" onclick="searchReports('single')">æœç´¢å…¬å‘Š</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å®šæœŸæŠ¥å‘Š -->
            <div id="panel-periodic" class="panel">
                <div class="form-card">
                    <div class="form-card-header">
                        <h3>ç­›é€‰æ¡ä»¶</h3>
                    </div>
                    <div class="form-card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">è‚¡ç¥¨ä»£ç  <span class="hint">ä¸å¡«é»˜è®¤å…¨éƒ¨</span></label>
                                <div class="input-with-btn">
                                    <input type="text" id="periodic-stocks" placeholder="å¤šä¸ªä»£ç ç”¨é€—å·éš”å¼€ï¼Œå¦‚ 000001,000002">
                                    <button class="btn btn-ghost" onclick="checkStock('periodic')">ç¡®å®š</button>
                                </div>
                                <div id="periodic-stock-status" class="status-msg"></div>
                                
                                <div class="file-box">
                                    <div class="file-box-label">æˆ–ä¸Šä¼ Excelæ–‡ä»¶ï¼ˆè‚¡ç¥¨ä»£ç æ”¾åŒä¸€åˆ—ï¼‰</div>
                                    <div class="input-with-btn">
                                        <input type="file" id="periodic-file" accept=".xlsx,.xls" style="flex:1;">
                                        <input type="text" id="periodic-column" placeholder="åˆ—å" style="width:80px;">
                                        <button class="btn btn-ghost" onclick="uploadExcel('periodic')">ç¡®å®š</button>
                                    </div>
                                </div>
                                <div id="periodic-file-status" class="status-msg"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">è‚¡ç¥¨æ¿å—</label>
                                <div class="checkbox-row">
                                    <label class="checkbox-tag"><input type="checkbox" value="ä¸»æ¿[æ²ª]" class="periodic-plate">ä¸»æ¿[æ²ª]</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="ä¸»æ¿[æ·±]" class="periodic-plate">ä¸»æ¿[æ·±]</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="åˆ›ä¸šæ¿" class="periodic-plate">åˆ›ä¸šæ¿</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="ç§‘åˆ›æ¿" class="periodic-plate">ç§‘åˆ›æ¿</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="åŒ—äº¤æ‰€" class="periodic-plate">åŒ—äº¤æ‰€</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æŠ¥å‘Šç±»å‹</label>
                                <div class="checkbox-row">
                                    <label class="checkbox-tag"><input type="checkbox" value="å¹´æŠ¥" class="periodic-category">å¹´æŠ¥</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="åŠå¹´æŠ¥" class="periodic-category">åŠå¹´æŠ¥</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="ä¸€å­£åº¦æŠ¥" class="periodic-category">ä¸€å­£åº¦æŠ¥</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="ä¸‰å­£åº¦æŠ¥" class="periodic-category">ä¸‰å­£åº¦æŠ¥</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group small">
                                <label class="form-label">èµ·å§‹å¹´åº¦</label>
                                <select id="periodic-begin-year"></select>
                            </div>
                            <div class="form-group small">
                                <label class="form-label">ç»ˆæ­¢å¹´åº¦</label>
                                <select id="periodic-end-year"></select>
                            </div>
                            <div class="form-group" style="flex:0;align-self:flex-end;">
                                <button class="btn btn-primary" onclick="searchReports('periodic')">æœç´¢å…¬å‘Š</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¤šè‚¡ -->
            <div id="panel-multi" class="panel active">
                <div class="form-card">
                    <div class="form-card-header">
                        <h3>ç­›é€‰æ¡ä»¶</h3>
                    </div>
                    <div class="form-card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">è‚¡ç¥¨ä»£ç  <span class="hint">ä¸å¡«é»˜è®¤å…¨éƒ¨</span></label>
                                <div class="input-with-btn">
                                    <input type="text" id="multi-stocks" placeholder="å¤šä¸ªä»£ç ç”¨é€—å·éš”å¼€">
                                    <button class="btn btn-ghost" onclick="checkStock('multi')">ç¡®å®š</button>
                                </div>
                                <div id="multi-stock-status" class="status-msg"></div>
                                
                                <div class="file-box">
                                    <div class="file-box-label">æˆ–ä¸Šä¼ Excelæ–‡ä»¶</div>
                                    <div class="input-with-btn">
                                        <input type="file" id="multi-file" accept=".xlsx,.xls" style="flex:1;">
                                        <input type="text" id="multi-column" placeholder="åˆ—å" style="width:80px;">
                                        <button class="btn btn-ghost" onclick="uploadExcel('multi')">ç¡®å®š</button>
                                    </div>
                                </div>
                                <div id="multi-file-status" class="status-msg"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æœç´¢å…³é”®è¯ <span class="hint">ç©ºæ ¼åˆ†éš”ï¼ŒåŒ…å«ä»»ä¸€å³å¯</span></label>
                                <div class="input-with-btn">
                                    <input type="text" id="multi-keywords" placeholder="ä¾‹å¦‚ï¼šç§å‹Ÿ åŸºé‡‘ å…±åŒæŠ•èµ„">
                                    <button class="btn btn-ghost" onclick="confirmKeyword('multi')">ç¡®å®š</button>
                                </div>
                                <div id="multi-keyword-status" class="status-msg"></div>
                                <div style="margin-top:8px;font-size:12px;color:#6b7280;">ğŸ’¡ å¤šä¸ªå…³é”®è¯ä¸ºâ€œæˆ–â€å…³ç³»ï¼ŒåŒ…å«ä»»æ„ä¸€ä¸ªå³å¯åŒ¹é…</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">æŠ¥å‘Šç±»å‹</label>
                                <div class="checkbox-row">
                                    <label class="checkbox-tag"><input type="checkbox" value="å¹´æŠ¥" class="multi-category">å¹´æŠ¥</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="åŠå¹´æŠ¥" class="multi-category">åŠå¹´æŠ¥</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="ä¸€å­£åº¦æŠ¥" class="multi-category">ä¸€å­£åº¦æŠ¥</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="ä¸‰å­£åº¦æŠ¥" class="multi-category">ä¸‰å­£åº¦æŠ¥</label>
                                    <label class="checkbox-tag"><input type="checkbox" value="å…¶ä»–" class="multi-category">å…¶ä»–</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group small">
                                <label class="form-label">èµ·å§‹æ—¥æœŸ</label>
                                <input type="date" id="multi-start-date" value="2024-01-01">
                            </div>
                            <div class="form-group small">
                                <label class="form-label">ç»ˆæ­¢æ—¥æœŸ</label>
                                <input type="date" id="multi-end-date" value="2024-12-31">
                            </div>
                            <div class="form-group" style="flex:0;align-self:flex-end;">
                                <button class="btn btn-primary" onclick="searchReports('multi')">æœç´¢å…¬å‘Š</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results -->
            <div id="results-card" class="results-card">
                <div class="results-header">
                    <div>
                        <h4>æœç´¢ç»“æœ</h4>
                        <div id="results-count" class="results-count"></div>
                    </div>
                    <div class="results-actions">
                        <button class="btn btn-ghost" onclick="selectAll()">å…¨é€‰</button>
                        <button class="btn btn-ghost" onclick="deselectAll()">å–æ¶ˆ</button>
                        <button class="btn btn-ghost" onclick="exportExcel()" style="background:#dbeafe;color:#1d4ed8;">ğŸ“„ å¯¼å‡ºExcel</button>
                        <button class="btn btn-success" onclick="downloadSelected()">ä¸‹è½½é€‰ä¸­</button>
                    </div>
                </div>
                <div class="results-table-wrap">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th style="width:40px;"><input type="checkbox" id="check-all" onchange="toggleAll(this)"></th>
                                <th style="width:100px;">è‚¡ç¥¨ä»£ç </th>
                                <th style="width:100px;">è‚¡ç¥¨åç§°</th>
                                <th style="width:100px;">æ—¥æœŸ</th>
                                <th>å…¬å‘Šæ ‡é¢˜</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Loading -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <div id="loading-text" class="loading-text">æ­£åœ¨åŠ è½½...</div>
        </div>
    </div>

    <script>
        let searchResults = [];
        let confirmedStocks = { single: [], periodic: [], multi: [] };
        const titles = {
            single: { title: 'å•è‚¡æŠ¥å‘Šä¸‹è½½', sub: 'ä¸‹è½½å•ä¸€è‚¡ç¥¨çš„å†å²å…¬å‘Šæ–‡ä»¶' },
            periodic: { title: 'å®šæœŸæŠ¥å‘Šä¸‹è½½', sub: 'æ‰¹é‡ä¸‹è½½å¹´æŠ¥ã€åŠå¹´æŠ¥ã€å­£æŠ¥' },
            multi: { title: 'å¤šè‚¡æŠ¥å‘Šä¸‹è½½', sub: 'åŒæ—¶ä¸‹è½½å¤šåªè‚¡ç¥¨çš„å…¬å‘Šæ–‡ä»¶' }
        };
        
        // åˆå§‹åŒ–å¹´ä»½
        (function() {
            for (let y = 2000; y <= 2025; y++) {
                ['periodic-begin-year', 'periodic-end-year'].forEach(id => {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y + 'å¹´';
                    if (y === 2024) opt.selected = true;
                    document.getElementById(id).appendChild(opt);
                });
            }
        })();
        
        // Tabåˆ‡æ¢
        document.querySelectorAll('[data-tab]').forEach(el => {
            el.addEventListener('click', function() {
                const tab = this.dataset.tab;
                if (!tab || tab === 'null') return;
                
                // æ›´æ–°å¯¼èˆª
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelector(`.nav-item[data-tab="${tab}"]`).classList.add('active');
                
                // æ›´æ–°å¡ç‰‡
                document.querySelectorAll('.stat-card[data-tab]').forEach(c => c.classList.remove('active'));
                const card = document.querySelector(`.stat-card[data-tab="${tab}"]`);
                if (card) card.classList.add('active');
                
                // æ›´æ–°é¢æ¿
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.getElementById(`panel-${tab}`).classList.add('active');
                
                // æ›´æ–°æ ‡é¢˜
                document.getElementById('header-title').textContent = titles[tab].title;
                document.querySelector('.header-subtitle').textContent = titles[tab].sub;
                
                // éšè—ç»“æœ
                document.getElementById('results-card').classList.remove('show');
            });
        });
        
        function showStatus(id, msg, type) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.className = `status-msg show ${type}`;
        }
        
        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('show');
        }
        
        async function checkStock(mode) {
            let codes;
            if (mode === 'single') codes = document.getElementById('single-stock').value;
            else if (mode === 'periodic') codes = document.getElementById('periodic-stocks').value;
            else codes = document.getElementById('multi-stocks').value;
            
            if (!codes.trim()) {
                showStatus(`${mode}-stock-status`, 'è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
                return;
            }
            
            try {
                const resp = await fetch('/api/check_stock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({codes})
                });
                const data = await resp.json();
                
                if (data.success) {
                    confirmedStocks[mode] = data.valid;
                    showStatus(`${mode}-stock-status`, `âœ“ å·²ç¡®è®¤ ${data.valid.length} ä¸ªä»£ç `, 'success');
                } else {
                    showStatus(`${mode}-stock-status`, `âœ— ä»£ç  ${data.invalid[0]} æ— æ•ˆ`, 'error');
                }
            } catch (e) {
                showStatus(`${mode}-stock-status`, 'éªŒè¯å¤±è´¥', 'error');
            }
        }
        
        async function uploadExcel(mode) {
            const fileInput = document.getElementById(`${mode}-file`);
            const columnInput = document.getElementById(`${mode}-column`);
            
            if (!fileInput.files[0]) {
                showStatus(`${mode}-file-status`, 'è¯·é€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }
            if (!columnInput.value.trim()) {
                showStatus(`${mode}-file-status`, 'è¯·è¾“å…¥åˆ—å', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('column', columnInput.value.trim());
            
            try {
                showLoading('è¯»å–Excel...');
                const resp = await fetch('/api/upload_excel', { method: 'POST', body: formData });
                const data = await resp.json();
                hideLoading();
                
                if (data.success) {
                    confirmedStocks[mode] = data.valid;
                    showStatus(`${mode}-file-status`, `âœ“ å·²è¯»å– ${data.count} ä¸ªä»£ç `, 'success');
                } else {
                    showStatus(`${mode}-file-status`, data.error, 'error');
                }
            } catch (e) {
                hideLoading();
                showStatus(`${mode}-file-status`, 'ä¸Šä¼ å¤±è´¥', 'error');
            }
        }
        
        function confirmKeyword(mode) {
            const kw = document.getElementById(`${mode}-keywords`).value.trim();
            if (!kw) {
                showStatus(`${mode}-keyword-status`, 'è¯·è¾“å…¥å…³é”®è¯', 'error');
            } else {
                showStatus(`${mode}-keyword-status`, `âœ“ å·²ç¡®è®¤`, 'success');
            }
        }
        
        function getChecked(className) {
            return Array.from(document.querySelectorAll(`.${className}:checked`)).map(el => el.value);
        }
        
        async function searchReports(mode) {
            let params = { mode };
            
            if (mode === 'single') {
                if (!confirmedStocks.single.length && !document.getElementById('single-stock').value.trim()) {
                    alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                    return;
                }
                params.stocks = confirmedStocks.single.length ? confirmedStocks.single : [document.getElementById('single-stock').value.trim()];
                params.keywords = document.getElementById('single-keywords').value;
                params.categories = getChecked('single-category');
                params.startDate = document.getElementById('single-start-date').value;
                params.endDate = document.getElementById('single-end-date').value;
            } else if (mode === 'periodic') {
                params.stocks = confirmedStocks.periodic;
                params.plates = getChecked('periodic-plate');
                params.categories = getChecked('periodic-category');
                params.beginYear = document.getElementById('periodic-begin-year').value;
                params.endYear = document.getElementById('periodic-end-year').value;
            } else {
                params.stocks = confirmedStocks.multi;
                params.keywords = document.getElementById('multi-keywords').value;
                params.categories = getChecked('multi-category');
                params.startDate = document.getElementById('multi-start-date').value;
                params.endDate = document.getElementById('multi-end-date').value;
            }
            
            showLoading('æ­£åœ¨æœç´¢å…¬å‘Š...');
            
            try {
                const resp = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                const data = await resp.json();
                hideLoading();
                
                if (data.success) {
                    if (!data.announcements || data.announcements.length === 0) {
                        alert('æœªæ£€ç´¢åˆ°å…¬å‘Š');
                        return;
                    }
                    searchResults = data.announcements;
                    displayResults(data);
                } else {
                    alert('æœç´¢å¤±è´¥: ' + data.error);
                }
            } catch (e) {
                hideLoading();
                alert('æœç´¢å¤±è´¥: ' + e.message);
            }
        }
        
        function displayResults(data) {
            const card = document.getElementById('results-card');
            const tbody = document.getElementById('results-tbody');
            const count = document.getElementById('results-count');
            
            card.classList.add('show');
            count.textContent = `å…± ${data.total} ç¯‡å…¬å‘Š`;
            
            tbody.innerHTML = data.announcements.map((ann, i) => {
                // ä»URLæå–æ—¥æœŸ
                const urlParts = (ann.url || '').split('/');
                const annDate = urlParts.length > 1 ? urlParts[1] : '';
                return `
                <tr>
                    <td><input type="checkbox" class="result-cb" data-index="${i}" checked></td>
                    <td><span class="code-badge">${ann.secCode}</span></td>
                    <td>${ann.secName}</td>
                    <td>${annDate}</td>
                    <td>${ann.title}</td>
                </tr>
                `;
            }).join('');
            
            card.scrollIntoView({ behavior: 'smooth' });
        }
        
        function toggleAll(el) {
            document.querySelectorAll('.result-cb').forEach(cb => cb.checked = el.checked);
        }
        function selectAll() {
            document.querySelectorAll('.result-cb').forEach(cb => cb.checked = true);
            document.getElementById('check-all').checked = true;
        }
        function deselectAll() {
            document.querySelectorAll('.result-cb').forEach(cb => cb.checked = false);
            document.getElementById('check-all').checked = false;
        }
        
        async function downloadSelected() {
            const selected = Array.from(document.querySelectorAll('.result-cb:checked'))
                .map(cb => searchResults[parseInt(cb.dataset.index)]);
            
            if (!selected.length) { alert('è¯·é€‰æ‹©å…¬å‘Š'); return; }
            
            showLoading(`æ­£åœ¨ä¸‹è½½ ${selected.length} ä¸ªæ–‡ä»¶...`);
            
            try {
                const resp = await fetch('/api/download', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({announcements: selected})
                });
                
                if (resp.ok) {
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `reports_${new Date().toISOString().slice(0,10)}.zip`;
                    a.click();
                    URL.revokeObjectURL(url);
                    hideLoading();
                    alert('ä¸‹è½½å®Œæˆï¼');
                } else {
                    hideLoading();
                    alert('ä¸‹è½½å¤±è´¥');
                }
            } catch (e) {
                hideLoading();
                alert('ä¸‹è½½å¤±è´¥: ' + e.message);
            }
        }
        
        async function exportExcel() {
            const selected = Array.from(document.querySelectorAll('.result-cb:checked'))
                .map(cb => searchResults[parseInt(cb.dataset.index)]);
            
            if (!selected.length) { alert('è¯·é€‰æ‹©è¦å¯¼å‡ºçš„å…¬å‘Š'); return; }
            
            showLoading(`æ­£åœ¨å¯¼å‡º ${selected.length} æ¡è®°å½•...`);
            
            try {
                const resp = await fetch('/api/export_excel', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({announcements: selected})
                });
                
                if (resp.ok) {
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `å…¬å‘Šåˆ—è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`;
                    a.click();
                    URL.revokeObjectURL(url);
                    hideLoading();
                    alert('å¯¼å‡ºæˆåŠŸï¼');
                } else {
                    hideLoading();
                    alert('å¯¼å‡ºå¤±è´¥');
                }
            } catch (e) {
                hideLoading();
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }
    </script>
</body>
</html>
